# Apply Terraform configuration to production environment.

name: Deploy to Prod

on:
  push:
    branches:
      # Trigger the workflow upon changes to main
      - main

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # Validate Terraform configuration and check for formatting issues
  validate-terraform-configuration:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - uses: actions/checkout@v3
      
      # Install Terraform CLI
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      - name: Prepare Terraform working directory
        run: terraform init

      - name: Validate Terraform configuration
        run: terraform validate

      - name: Validate Terraform formatting
        run: terraform fmt -recursive -check

  # Convert Sigma rules to Sumo Logic queries
  convert-sigma-rules:
    needs: validate-terraform-configuration
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Convert Sigma Rules to Sumo Logic Queries
        run: python convert_sigma_rules.py

      - name: Upload Converted Rules
        uses: actions/upload-artifact@v4
        with:
          name: converted-rules
          path: converted_rules.json
          retention-days: 1

  # Apply Terraform configuration to prod environment
  deploy-to-prod:
    needs: convert-sigma-rules
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v3

      - name: Download Converted Rules
        uses: actions/download-artifact@v4
        with:
          name: converted-rules

      # Install Terraform CLI
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      - name: Prepare Terraform working directory
        run: terraform init

      - name: Create Terraform-managed infrastructure
        run: terraform apply -auto-approve
        # Set Terraform environment variables from GitHub Secrets
        env:
          TF_VAR_SUMOLOGIC_ACCESS_ID: ${{ secrets.TF_VAR_SUMOLOGIC_ACCESS_ID }}
          TF_VAR_SUMOLOGIC_ACCESS_KEY: ${{ secrets.TF_VAR_SUMOLOGIC_ACCESS_KEY }}
          TF_VAR_TINES_WEBHOOK_URL_FOR_SUMOLOGIC_ALERTS: ${{ secrets.TINES_WEBHOOK_URL_FOR_SUMOLOGIC_ALERTS }}
