# Apply Terraform configuration to dev environment and test detections.

name: Test & Deploy in Dev

on:
  # Trigger the workflow on pull requests
  pull_request:
    branches: [ "*" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

jobs:
  # Validate Terraform configuration and check for formatting issues
  validate-terraform-configuration:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - uses: actions/checkout@v3
      
      # Install Terraform CLI
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      - name: Prepare Terraform working directory
        run: terraform init

      - name: Validate Terraform configuration
        run: terraform validate

      - name: Validate Terraform formatting
        run: terraform fmt -recursive -check

  # Convert Sigma rules to Sumo Logic queries
  convert-sigma-rules:
    needs: validate-terraform-configuration
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v3

      - name: Clone sigconverter.io repository
        run: |
          git clone https://github.com/magicsword-io/sigconverter.io.git /tmp/sigconverter
          cd /tmp/sigconverter

      - name: Build and run sigconverter container
        run: |
          cd /tmp/sigconverter
          docker build -t sigconverter:local .
          docker run -d -p 8000:8000 --name sigconverter sigconverter:local
          # Wait for container to be ready
          sleep 10

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Convert Sigma Rules to Sumo Logic Queries
        run: python convert_sigma_rules.py
        env:
          SIGCONVERTER_URL: http://localhost:8000

      - name: Stop sigconverter container
        if: always()
        run: docker stop sigconverter && docker rm sigconverter

      - name: Upload Converted Rules
        uses: actions/upload-artifact@v4
        with:
          name: converted-rules
          path: converted_rules.json
          retention-days: 1

  # Apply Terraform configuration to dev environment
  deploy-to-dev:
    needs: convert-sigma-rules
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v3

      - name: Download Converted Rules
        uses: actions/download-artifact@v4
        with:
          name: converted-rules

      # Install Terraform CLI
      - uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.5.2

      - name: Prepare Terraform working directory
        run: terraform init

      - name: Create Terraform-managed infrastructure
        run: terraform apply -auto-approve
        # Set Terraform environment variables from GitHub Secrets
        env:
          TF_VAR_SUMOLOGIC_ACCESS_ID: ${{ secrets.TF_VAR_SUMOLOGIC_ACCESS_ID }}
          TF_VAR_SUMOLOGIC_ACCESS_KEY: ${{ secrets.TF_VAR_SUMOLOGIC_ACCESS_KEY }}
          TF_VAR_TINES_WEBHOOK_URL_FOR_SUMOLOGIC_ALERTS: ${{ secrets.TINES_WEBHOOK_URL_FOR_SUMOLOGIC_ALERTS }}

  # Trigger detection rules in dev environment
  trigger-detections-in-dev:
    needs: deploy-to-dev
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - uses: actions/checkout@v3
      
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Trigger Detection Rules in Dev
        run: python -m detections_cli --run-all-triggers
        env:
          LOGGING_LEVEL: ${{ vars.LOGGING_LEVEL }}
          OKTA_DEV_URL: ${{ vars.OKTA_DEV_URL }}
          OKTA_DEV_API_TOKEN: ${{ secrets.OKTA_DEV_API_TOKEN }}
          TEST_OKTA_USER_FIRST_NAME: ${{ vars.TEST_OKTA_USER_FIRST_NAME }}
          TEST_OKTA_USER_LAST_NAME: ${{ vars.TEST_OKTA_USER_LAST_NAME }}
          TEST_OKTA_USER_EMAIL: ${{ vars.TEST_OKTA_USER_EMAIL }}
          TEST_OKTA_USER_PASSWORD: ${{ secrets.TEST_OKTA_USER_PASSWORD }}

    # Validate that alerts were generated after detection rules were triggered
  check-for-alerts:
    needs: trigger-detections-in-dev
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Wait 10m for Alerts Creation
        run: sleep 10m
    
      - name: Validate Alert Creation in Dev
        run: python -m detections_cli --validate-alerts
        env:
          LOGGING_LEVEL: ${{ vars.LOGGING_LEVEL }}

          OKTA_DEV_URL: ${{ vars.OKTA_DEV_URL }}
          OKTA_DEV_API_TOKEN: ${{ secrets.OKTA_DEV_API_TOKEN }}
          TEST_OKTA_USER_FIRST_NAME: ${{ vars.TEST_OKTA_USER_FIRST_NAME }}
          TEST_OKTA_USER_LAST_NAME: ${{ vars.TEST_OKTA_USER_LAST_NAME }}
          TEST_OKTA_USER_EMAIL: ${{ vars.TEST_OKTA_USER_EMAIL }}
          TEST_OKTA_USER_PASSWORD: ${{ secrets.TEST_OKTA_USER_PASSWORD }}

          GITHUB_DAC_REPO_API_URL: ${{ vars.GH_DAC_REPO_API_URL }}
          GITHUB_DAC_REPO_API_TOKEN: ${{ secrets.GH_DAC_REPO_API_TOKEN }}

